# ðŸš€ GITHUB ACTIONS - BUILD iOS AUTOMÃTICO - MiProveedor
# Configurado por MobilePro para desarrollo sin Mac - ROLLBACK STABLE

name: ðŸŽ iOS Build - MiProveedor

on:
  push:
    branches: [ main, develop, ios-* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Permite ejecutar manualmente desde GitHub

env:
  FLUTTER_VERSION: '3.24.3'
  JAVA_VERSION: '17'

jobs:
  # ðŸ§ª JOB 1: ANÃLISIS Y TESTS
  analyze:
    name: ðŸ” AnÃ¡lisis de CÃ³digo
    runs-on: ubuntu-latest
    steps:
    - name: ðŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        
    - name: ðŸ“¦ Dependencies
      run: flutter pub get
      
    - name: ðŸ” Analyze
      run: flutter analyze --no-fatal-infos || echo "âš ï¸ Analyzer completado con warnings, continuando build..."
      
    - name: ðŸ§ª Tests
      run: flutter test --coverage || echo "ðŸ“ No tests found, skipping..."
      
    - name: ðŸ“Š Upload Coverage
      uses: codecov/codecov-action@v4
      if: success()
      with:
        file: coverage/lcov.info

  # ðŸ“± JOB 2: BUILD iOS
  build-ios:
    name: ðŸŽ Build iOS
    runs-on: macos-latest
    needs: analyze
    
    steps:
    # ðŸ“¥ 1. Checkout del cÃ³digo
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    # ðŸŽ 2. Setup Xcode 15.x (Stable para Firebase Swift 5.x compatibility)
    - name: ðŸŽ Setup Xcode 15.x for Firebase Swift 5.x Compatibility
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'
        
    # â˜• 3. Setup Java (necesario para Flutter)
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: ${{ env.JAVA_VERSION }}
        
    # ðŸ¦ 4. Setup Flutter
    - name: ðŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        
    # ðŸ“¦ 5. Install dependencies
    - name: ðŸ“¦ Flutter Pub Get
      run: flutter pub get
      
    # ðŸ”§ 6. Flutter Clean + Force Firebase Swift 5.x Versions
    - name: ðŸ”§ Flutter Clean + Force Firebase Swift 5.x
      run: |
        echo "ðŸ”§ Limpiando proyecto completamente para Firebase Swift 5.x..."
        flutter clean
        
        echo "ðŸ—‘ï¸ Eliminando locks para forzar versiones especÃ­ficas:"
        rm -f pubspec.lock
        rm -f ios/Podfile.lock
        rm -rf ios/Pods/
        rm -rf build/
        
        echo "ðŸ“¦ Reinstalando dependencies con versiones Firebase Swift 5.x:"
        flutter pub get
        
        echo "ðŸ” Configurando environment para GitHub Actions:"
        # Fix common GitHub Actions iOS issues
        export COCOAPODS_DISABLE_STATS=true
        export FLUTTER_BUILD_MODE=release
        # Ensure proper permissions
        chmod +x ios/Runner.xcodeproj/
        # Create required directories
        mkdir -p ios/Runner.xcworkspace/
        mkdir -p build/ios/iphoneos/
        
        echo "Environment configurado para CI builds con Firebase Swift 5.x"
        echo "Verificando versiones Flutter dependencies:"
        flutter pub deps | grep firebase
      
    # ðŸŽ 7. Setup iOS dependencies + CocoaPods Integration Fix
    - name: ðŸŽ Install CocoaPods + Integration Fix
      run: |
        cd ios
        # Limpiar pods anteriores
        pod deintegrate 2>/dev/null || true
        rm -rf Pods/ Podfile.lock
        # Instalar fresh
        pod install --repo-update
        
        echo "ðŸ”§ Aplicando CocoaPods integration fix..."
        chmod +x ../scripts/setup_cocoapods_integration.sh
        ../scripts/setup_cocoapods_integration.sh
        
        echo "âœ… CocoaPods integration completed"
        
    # ðŸ” 8. Verificar configuraciÃ³n iOS
    - name: ðŸ” Verify iOS Setup
      run: |
        echo "ðŸ” Verificando configuraciÃ³n iOS..."
        ls -la ios/Runner/
        if [ -f "ios/Runner/GoogleService-Info.plist" ]; then
          echo "âœ… GoogleService-Info.plist encontrado"
        else
          echo "âš ï¸ ADVERTENCIA: GoogleService-Info.plist NO encontrado"
          echo "ðŸ“‹ Para apps con Firebase, aÃ±Ã¡delo a ios/Runner/"
        fi
        
    # ðŸ“± 9. Build iOS App (sin code signing + verbose logging)
    - name: ðŸ“± Build iOS App
      run: |
        echo "ðŸ”¨ Iniciando build iOS con logging detallado..."
        echo "ðŸ” Verificando estado pre-build:"
        ls -la ios/
        echo "ðŸ” Verificando Podfile.lock:"
        cat ios/Podfile.lock | head -20
        echo "ðŸ” Verificando workspace:"
        ls -la ios/Runner.xcworkspace/
        
        echo "ðŸ› ï¸ Configurando environment para GitHub Actions:"
        export FLUTTER_BUILD_MODE=release
        export COCOAPODS_DISABLE_STATS=true
        
        echo "ðŸ”¨ Ejecutando flutter build ios con verbose logging:"
        flutter build ios --release --no-codesign --verbose --dart-define=GITHUB_ACTIONS=true
        
        echo "âœ… Build completado - verificando outputs:"
        ls -la build/ios/iphoneos/
        echo "Build status: $?"
        
        if [ $? -eq 0 ]; then
          echo "âœ… Ã‰XITO: Build iOS completado exitosamente"
        else
          echo "âŒ ERROR: Build iOS fallÃ³ - capturando informaciÃ³n debug:"
          echo "Flutter doctor:"
          flutter doctor -v
          echo "Xcode version:"
          xcodebuild -version
          echo "Available SDKs:"
          xcodebuild -showsdks
          echo "Pods status:"
          cd ios && pod --version && cd ..
          exit 1
        fi
        
    # ðŸ“¦ 10. Create IPA (sin signing para distribuciÃ³n)
    - name: ðŸ“¦ Create IPA Archive
      run: |
        echo "ðŸ“¦ Creando archivo IPA..."
        cd build/ios/iphoneos
        
        # Crear estructura IPA
        mkdir -p Payload
        cp -r Runner.app Payload/
        
        # InformaciÃ³n del build
        BUILD_NUMBER=${{ github.run_number }}
        DATE=$(date '+%Y%m%d_%H%M')
        IPA_NAME="MiProveedor-iOS-${BUILD_NUMBER}-${DATE}.ipa"
        
        # Crear IPA
        zip -r "${IPA_NAME}" Payload/
        
        # Info
        echo "ðŸ“± IPA creado: ${IPA_NAME}"
        ls -lh "${IPA_NAME}"
        
        # Mover a directorio accesible
        mv "${IPA_NAME}" ../../../
        
        echo "âœ… IPA listo para descarga"
        
    # â¬†ï¸ 11. Upload IPA como Artifact
    - name: â¬†ï¸ Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: MiProveedor-iOS-Build-${{ github.run_number }}
        path: MiProveedor-iOS-*.ipa
        retention-days: 30
        
    # ðŸ“Š 12. Build Summary
    - name: ðŸ“Š Build Summary
      run: |
        echo "ðŸŽ‰ BUILD COMPLETADO EXITOSAMENTE!"
        echo "=================================="
        echo "ðŸ“± Proyecto: MiProveedor"
        echo "ðŸ”¨ Build #${{ github.run_number }}"
        echo "ðŸ“… Fecha: $(date)"
        echo "ðŸŽ Plataforma: iOS"
        echo "ðŸ“¦ Archivo: MiProveedor-iOS-${{ github.run_number }}-*.ipa"
        echo ""
        echo "ðŸ“¥ CÃ“MO DESCARGAR:"
        echo "1. Ve a la pestaÃ±a 'Actions' de tu repositorio"
        echo "2. Haz clic en este workflow run"
        echo "3. Descarga el artifact 'MiProveedor-iOS-Build-${{ github.run_number }}'"
        echo ""
        echo "âš ï¸  NOTA IMPORTANTE:"
        echo "El archivo .ipa NO estÃ¡ firmado (code signed)"
        echo "Para instalar en dispositivo real necesitas:"
        echo "- Abrir en Xcode y firmar con tu Apple Developer Account"
        echo "- O usar herramientas como Diawi para distribuciÃ³n"
        echo ""
        echo "ðŸš€ Â¡Tu app estÃ¡ lista para iOS!"
        echo "   Desarrollado por MobilePro âœ¨"
        
    # ðŸ”” 13. NotificaciÃ³n de Ã©xito (opcional)
    - name: ðŸ”” Success Notification
      if: success()
      run: |
        echo "âœ… Ã‰XITO: Build iOS completado sin errores"
        
    # âŒ 14. NotificaciÃ³n de error (opcional)  
    - name: âŒ Error Notification
      if: failure()
      run: |
        echo "âŒ ERROR: El build iOS fallÃ³"
        echo "ðŸ” Revisa los logs anteriores para detalles"
        echo "ðŸ’¡ Problemas comunes:"
        echo "   - Dependencias en pubspec.yaml"
        echo "   - ConfiguraciÃ³n Firebase"
        echo "   - Errores de sintaxis Dart"

# ðŸŽ¯ CONFIGURACIÃ“N ADICIONAL
# Para builds con code signing (Apple Developer Account):
# 1. Ve a Settings > Secrets and Variables > Actions
# 2. AÃ±ade estos secrets:
#    - IOS_CERTIFICATE_BASE64
#    - IOS_CERTIFICATE_PASSWORD  
#    - IOS_PROVISIONING_PROFILE_BASE64
#    - KEYCHAIN_PASSWORD
