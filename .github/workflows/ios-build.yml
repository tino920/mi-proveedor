# 🚀 GITHUB ACTIONS - BUILD iOS FIREBASE ESTABLE - MiProveedor
# Firebase downgraded a versiones estables sin bugs xcfilelist
# Workflow simplificado y efectivo

name: 🍎 iOS Build - Firebase Estable

on:
  push:
    branches: [ main, develop, ios-* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.3'
  JAVA_VERSION: '17'

jobs:
  # 🧪 ANÁLISIS RÁPIDO
  analyze:
    name: 🔍 Análisis
    runs-on: ubuntu-latest
    steps:
    - name: 📥 Checkout
      uses: actions/checkout@v4
      
    - name: 🐦 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        
    - name: 📦 Dependencies
      run: flutter pub get
      
    - name: 🔍 Analyze
      run: flutter analyze --no-fatal-infos || echo "⚠️ Analyzer warnings ignorados"

  # 📱 BUILD iOS CON FIREBASE ESTABLE
  build-ios:
    name: 🍎 Build iOS Firebase Estable
    runs-on: macos-latest
    needs: analyze
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 🍎 Setup Xcode 15.4
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'
        
    - name: ☕ Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: 🐦 Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: 🔥 Reset Completo
      run: |
        echo "🔥 Reset completo para Firebase estable..."
        flutter clean
        rm -rf ios/Pods/
        rm -f ios/Podfile.lock
        rm -rf ios/.symlinks/
        rm -rf ios/Runner.xcworkspace/
        rm -rf build/
        rm -rf .dart_tool/
        echo "✅ Reset completado"

    - name: 📦 Flutter Pub Get con Firebase Estable
      run: |
        echo "📦 Instalando Firebase versiones estables..."
        flutter pub get
        
        echo "🔥 Verificando versiones Firebase instaladas:"
        flutter pub deps | grep firebase
        
        echo "✅ Firebase estable instalado"

    - name: 🔍 Verificar Firebase Config
      run: |
        if [ -f "ios/Runner/GoogleService-Info.plist" ]; then
          echo "✅ GoogleService-Info.plist encontrado"
        else
          echo "⚠️ GoogleService-Info.plist NO encontrado"
        fi

    - name: 🍎 CocoaPods Install con Firebase Estable
      run: |
        echo "🍎 CocoaPods install con Firebase estable..."
        cd ios
        
        # Verificar Podfile
        echo "📄 Verificando Podfile coherente:"
        grep -A 3 -B 3 "flutter_install_all_ios_pods" Podfile
        
        # Install limpio con versiones estables
        pod install --repo-update --clean-install
        
        echo "✅ CocoaPods install completado con Firebase estable"
        
        # Verificar que no hay problemas xcfilelist
        echo "🔍 Verificando estructura Pods generada:"
        if [ -d "Pods/Target Support Files/FirebaseAnalytics" ]; then
          echo "✅ FirebaseAnalytics target directory existe"
          ls -la "Pods/Target Support Files/FirebaseAnalytics/" | head -5
        fi
        
        if [ -d "Pods/Target Support Files/GoogleAppMeasurement" ]; then
          echo "✅ GoogleAppMeasurement target directory existe"
          ls -la "Pods/Target Support Files/GoogleAppMeasurement/" | head -5
        fi

    - name: 🔨 Build iOS con Firebase Estable
      run: |
        echo "🔨 Iniciando build iOS con Firebase estable..."
        echo "🎯 Versiones Firebase sin bugs xcfilelist"
        
        export FLUTTER_BUILD_MODE=release
        export COCOAPODS_DISABLE_STATS=true
        
        # Build con versiones estables
        flutter build ios --release --no-codesign --verbose
        
        echo "✅ Build iOS completado con Firebase estable"

    - name: 📦 Create IPA
      run: |
        echo "📦 Creando IPA..."
        cd build/ios/iphoneos
        
        mkdir -p Payload
        cp -r Runner.app Payload/
        
        BUILD_NUMBER=${{ github.run_number }}
        DATE=$(date '+%Y%m%d_%H%M')
        IPA_NAME="MiProveedor-Firebase-Estable-${BUILD_NUMBER}-${DATE}.ipa"
        
        zip -r "${IPA_NAME}" Payload/
        mv "${IPA_NAME}" ../../../
        
        echo "📱 IPA creado: ${IPA_NAME}"

    - name: ⬆️ Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: MiProveedor-Firebase-Estable-Build-${{ github.run_number }}
        path: MiProveedor-Firebase-Estable-*.ipa
        retention-days: 30

    - name: 🎉 Success Summary
      run: |
        echo "🎉 BUILD CON FIREBASE ESTABLE EXITOSO!"
        echo "===================================="
        echo "✅ Firebase: Downgraded a versiones estables"
        echo "✅ Versiones sin bugs xcfilelist conocidos"
        echo "✅ Build: Completado sin errores Firebase"
        echo "✅ CocoaPods: Funcionando con versiones compatibles"
        echo ""
        echo "🔥 FIREBASE VERSIONS UTILIZADAS:"
        echo "   firebase_core: ^2.15.1"
        echo "   firebase_auth: ^4.9.0"
        echo "   cloud_firestore: ^4.9.1"
        echo "   firebase_analytics: ^10.4.5"
        echo ""
        echo "📥 Descarga el artifact - APP CON FIREBASE FUNCIONAL"
