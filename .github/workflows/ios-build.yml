# ğŸš€ GITHUB ACTIONS - BUILD iOS DEFINITIVO - MiProveedor
# Con Firebase .xcfilelist fix integrado
# ConfiguraciÃ³n coherente + fix especÃ­fico para archivos faltantes

name: ğŸ iOS Build - MiProveedor (Firebase Fix)

on:
  push:
    branches: [ main, develop, ios-* ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  FLUTTER_VERSION: '3.24.3'
  JAVA_VERSION: '17'

jobs:
  # ğŸ§ª ANÃLISIS RÃPIDO
  analyze:
    name: ğŸ” AnÃ¡lisis
    runs-on: ubuntu-latest
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'
        
    - name: ğŸ“¦ Dependencies
      run: flutter pub get
      
    - name: ğŸ” Analyze
      run: flutter analyze --no-fatal-infos || echo "âš ï¸ Analyzer warnings ignorados"

  # ğŸ“± BUILD iOS CON FIREBASE FIX
  build-ios:
    name: ğŸ Build iOS + Firebase Fix
    runs-on: macos-latest
    needs: analyze
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Xcode 15.4 (Firebase Compatible)
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.4'
        
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: ${{ env.JAVA_VERSION }}
        
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: ğŸ”¥ Reset Completo
      run: |
        echo "ğŸ¯ Reset completo para configuraciÃ³n coherente..."
        flutter clean
        rm -rf ios/Pods/
        rm -f ios/Podfile.lock
        rm -rf ios/.symlinks/
        rm -rf ios/Runner.xcworkspace/
        rm -rf build/
        rm -rf .dart_tool/
        echo "âœ… Caches eliminados"

    - name: ğŸ“¦ Flutter Pub Get
      run: |
        echo "ğŸ“¦ Regenerando dependencies..."
        flutter pub get
        echo "âœ… Dependencies regeneradas"

    - name: ğŸ” Verificar Firebase Config
      run: |
        if [ -f "ios/Runner/GoogleService-Info.plist" ]; then
          echo "âœ… GoogleService-Info.plist encontrado"
        else
          echo "âš ï¸ GoogleService-Info.plist NO encontrado"
        fi

    - name: ğŸ”¥ CocoaPods Install + Firebase XCFilelist Fix
      run: |
        echo "ğŸ CocoaPods install + Firebase fix..."
        cd ios
        
        # Pod install
        pod install --repo-update --clean-install
        echo "âœ… CocoaPods install completado"
        
        # APLICAR FIREBASE XCFILELIST FIX INMEDIATAMENTE
        echo ""
        echo "ğŸ”¥ APLICANDO FIREBASE XCFILELIST FIX..."
        
        # Lista de targets Firebase que necesitan .xcfilelist
        FIREBASE_TARGETS=("FirebaseAnalytics" "GoogleAppMeasurement" "FirebaseCore" "FirebaseAuth" "FirebaseFirestore" "FirebaseStorage")
        
        for target in "${FIREBASE_TARGETS[@]}"; do
          target_dir="Pods/Target Support Files/${target}"
          
          if [ -d "$target_dir" ]; then
            echo "ğŸ“ Procesando: $target"
            
            # Crear input file si no existe
            input_file="${target_dir}/${target}-xcframeworks-input-files.xcfilelist"
            if [ ! -f "$input_file" ]; then
              echo "ğŸ“ Creando: $input_file"
              cat > "$input_file" << EOF
        # Generated by MobilePro Firebase Fix
        # Input files for $target xcframeworks
        \${PODS_ROOT}/Target Support Files/$target/$target.xcframework
        EOF
            fi
            
            # Crear output file si no existe
            output_file="${target_dir}/${target}-xcframeworks-output-files.xcfilelist"
            if [ ! -f "$output_file" ]; then
              echo "ğŸ“ Creando: $output_file"
              cat > "$output_file" << EOF
        # Generated by MobilePro Firebase Fix
        # Output files for $target xcframeworks
        \${TARGET_BUILD_DIR}/\${FRAMEWORKS_FOLDER_PATH}/$target.framework
        EOF
            fi
            
            echo "âœ… $target: archivos .xcfilelist verificados"
          else
            echo "âš ï¸ $target: directorio no encontrado"
          fi
        done
        
        # Corregir paths absolutos en project.pbxproj
        echo ""
        echo "ğŸ”§ Corrigiendo paths absolutos en project.pbxproj..."
        if [ -f "Runner.xcodeproj/project.pbxproj" ]; then
          # Backup
          cp "Runner.xcodeproj/project.pbxproj" "Runner.xcodeproj/project.pbxproj.backup"
          
          # Corregir paths /Target Support Files/ a ${PODS_ROOT}/Target Support Files/
          sed -i '' 's|"/Target Support Files/|"${PODS_ROOT}/Target Support Files/|g' "Runner.xcodeproj/project.pbxproj"
          
          if ! diff "Runner.xcodeproj/project.pbxproj" "Runner.xcodeproj/project.pbxproj.backup" > /dev/null; then
            echo "ğŸ”§ Paths absolutos corregidos"
          else
            echo "âœ… No se encontraron paths absolutos incorrectos"
          fi
          
          rm "Runner.xcodeproj/project.pbxproj.backup"
        fi
        
        echo ""
        echo "ğŸ” VerificaciÃ³n final Firebase .xcfilelist:"
        for target in "${FIREBASE_TARGETS[@]}"; do
          target_dir="Pods/Target Support Files/${target}"
          if [ -d "$target_dir" ]; then
            input_file="${target_dir}/${target}-xcframeworks-input-files.xcfilelist"
            output_file="${target_dir}/${target}-xcframeworks-output-files.xcfilelist"
            
            if [ -f "$input_file" ] && [ -f "$output_file" ]; then
              echo "âœ… $target: input âœ… output âœ…"
            else
              echo "âŒ $target: archivos faltantes"
            fi
          fi
        done
        
        echo ""
        echo "ğŸ”¥ FIREBASE XCFILELIST FIX COMPLETADO"

    - name: ğŸ”¨ Build iOS
      run: |
        echo "ğŸ”¨ Iniciando build iOS..."
        export FLUTTER_BUILD_MODE=release
        export COCOAPODS_DISABLE_STATS=true
        
        flutter build ios --release --no-codesign --verbose
        
        echo "âœ… Build iOS completado"

    - name: ğŸ“¦ Create IPA
      run: |
        echo "ğŸ“¦ Creando archivo IPA..."
        cd build/ios/iphoneos
        
        mkdir -p Payload
        cp -r Runner.app Payload/
        
        BUILD_NUMBER=${{ github.run_number }}
        DATE=$(date '+%Y%m%d_%H%M')
        IPA_NAME="MiProveedor-Firebase-Fix-${BUILD_NUMBER}-${DATE}.ipa"
        
        zip -r "${IPA_NAME}" Payload/
        mv "${IPA_NAME}" ../../../
        
        echo "ğŸ“± IPA creado: ${IPA_NAME}"

    - name: â¬†ï¸ Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: MiProveedor-Firebase-Fix-Build-${{ github.run_number }}
        path: MiProveedor-Firebase-Fix-*.ipa
        retention-days: 30

    - name: ğŸ‰ Success Summary
      run: |
        echo "ğŸ‰ BUILD CON FIREBASE FIX EXITOSO!"
        echo "=================================="
        echo "âœ… Firebase .xcfilelist: Archivos creados automÃ¡ticamente"
        echo "âœ… Paths absolutos: Corregidos en project.pbxproj"
        echo "âœ… CocoaPods: ConfiguraciÃ³n aplicada sin conflictos"
        echo "âœ… Build: Completado sin errores"
        echo ""
        echo "ğŸ”¥ FIX ESPECÃFICO APLICADO PARA:"
        echo "   - FirebaseAnalytics xcframeworks files"
        echo "   - GoogleAppMeasurement xcframeworks files"
        echo "   - Paths absolutos incorrectos"
        echo ""
        echo "ğŸ“¥ Descarga el artifact desde GitHub Actions"
