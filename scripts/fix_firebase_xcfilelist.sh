#!/bin/bash

# MobilePro - FIX ESPECÃFICO FIREBASE XCFILELIST
# Crear archivos .xcfilelist faltantes para Firebase Analytics y GoogleAppMeasurement
# Ejecutar desde directorio ios/ despuÃ©s de pod install

echo "ğŸ”¥ FIX FIREBASE XCFILELIST - MobilePro"
echo "====================================="

echo "ğŸ“‚ Working directory: $(pwd)"

# Verificar que estamos en el directorio correcto
if [ ! -d "Pods" ]; then
    echo "âŒ Error: Directorio Pods no encontrado. Ejecutar desde ios/"
    exit 1
fi

echo "âœ… Directorio Pods encontrado"

# Lista de targets Firebase que necesitan .xcfilelist files
FIREBASE_TARGETS=(
    "FirebaseAnalytics"
    "GoogleAppMeasurement" 
    "FirebaseCore"
    "FirebaseAuth"
    "FirebaseFirestore"
    "FirebaseStorage"
    "FirebaseMessaging"
    "FirebaseCrashlytics"
)

echo ""
echo "ğŸ” Verificando y creando archivos .xcfilelist para Firebase targets..."

for target in "${FIREBASE_TARGETS[@]}"; do
    target_dir="Pods/Target Support Files/${target}"
    
    if [ -d "$target_dir" ]; then
        echo ""
        echo "ğŸ“ Procesando: $target"
        
        # Archivos .xcfilelist que necesita cada target
        input_file="${target_dir}/${target}-xcframeworks-input-files.xcfilelist"
        output_file="${target_dir}/${target}-xcframeworks-output-files.xcfilelist"
        
        # Crear input file si no existe
        if [ ! -f "$input_file" ]; then
            echo "ğŸ“ Creando: $input_file"
            cat > "$input_file" << EOF
# Generated by MobilePro Firebase Fix
# Input files for $target xcframeworks
\${PODS_ROOT}/Target Support Files/$target/$target.xcframework
EOF
        else
            echo "âœ… Ya existe: $input_file"
        fi
        
        # Crear output file si no existe
        if [ ! -f "$output_file" ]; then
            echo "ğŸ“ Creando: $output_file"
            cat > "$output_file" << EOF
# Generated by MobilePro Firebase Fix  
# Output files for $target xcframeworks
\${TARGET_BUILD_DIR}/\${FRAMEWORKS_FOLDER_PATH}/$target.framework
EOF
        else
            echo "âœ… Ya existe: $output_file"
        fi
        
        echo "âœ… $target: archivos .xcfilelist verificados"
    else
        echo "âš ï¸ Target directory no encontrado: $target_dir"
    fi
done

echo ""
echo "ğŸ”§ Corrigiendo paths absolutos en project.pbxproj..."

# Verificar si el project.pbxproj tiene paths absolutos incorrectos
if [ -f "Runner.xcodeproj/project.pbxproj" ]; then
    # Backup
    cp "Runner.xcodeproj/project.pbxproj" "Runner.xcodeproj/project.pbxproj.backup"
    
    # Corregir paths que empiecen con /Target Support Files/ 
    sed -i '' 's|"/Target Support Files/|"${PODS_ROOT}/Target Support Files/|g' "Runner.xcodeproj/project.pbxproj"
    
    # Verificar si se hicieron cambios
    if diff "Runner.xcodeproj/project.pbxproj" "Runner.xcodeproj/project.pbxproj.backup" > /dev/null; then
        echo "âœ… No se encontraron paths absolutos incorrectos"
        rm "Runner.xcodeproj/project.pbxproj.backup"
    else
        echo "ğŸ”§ Paths absolutos corregidos en project.pbxproj"
        echo "ğŸ“‹ Backup guardado como project.pbxproj.backup"
    fi
else
    echo "âš ï¸ project.pbxproj no encontrado"
fi

echo ""
echo "ğŸ” VerificaciÃ³n final..."

# Verificar archivos creados
for target in "${FIREBASE_TARGETS[@]}"; do
    target_dir="Pods/Target Support Files/${target}"
    if [ -d "$target_dir" ]; then
        input_file="${target_dir}/${target}-xcframeworks-input-files.xcfilelist"
        output_file="${target_dir}/${target}-xcframeworks-output-files.xcfilelist"
        
        input_exists=""
        output_exists=""
        
        if [ -f "$input_file" ]; then
            input_exists="âœ…"
        else
            input_exists="âŒ"
        fi
        
        if [ -f "$output_file" ]; then
            output_exists="âœ…"
        else
            output_exists="âŒ"
        fi
        
        echo "$target: input $input_exists output $output_exists"
    fi
done

echo ""
echo "âœ… FIX FIREBASE XCFILELIST COMPLETADO"
echo "ğŸ¯ Archivos .xcfilelist creados para todos los targets Firebase"
echo "ğŸ”§ Paths absolutos corregidos en project.pbxproj"  
echo "ğŸš€ Proyecto listo para build iOS"
