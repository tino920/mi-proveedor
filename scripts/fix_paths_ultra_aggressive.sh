#!/bin/bash

# MobilePro - FIX ULTRA-AGRESIVO PARA PATHS ABSOLUTOS
# VERSIÃ“N DEFINITIVA: Corrige project.pbxproj directamente + crea archivos
# Este fix GARANTIZA que se resuelvan los paths absolutos

echo "ðŸ”¥ FIX ULTRA-AGRESIVO PATHS ABSOLUTOS - MobilePro"
echo "==============================================="

echo "ðŸ“‚ Working directory: $(pwd)"

# Verificar archivos crÃ­ticos
if [ ! -f "Runner.xcodeproj/project.pbxproj" ]; then
    echo "âŒ Error: project.pbxproj no encontrado"
    exit 1
fi

if [ ! -d "Pods" ]; then
    echo "âŒ Error: Directorio Pods no encontrado"
    exit 1
fi

echo "âœ… Archivos crÃ­ticos encontrados"

echo ""
echo "ðŸ” DIAGNÃ“STICO INICIAL - BUSCANDO PATHS ABSOLUTOS..."

# Buscar paths problemÃ¡ticos en project.pbxproj
problematic_paths=$(grep -n "Target Support Files" "Runner.xcodeproj/project.pbxproj" | head -10)
if [ -n "$problematic_paths" ]; then
    echo "âŒ PATHS PROBLEMÃTICOS ENCONTRADOS:"
    echo "$problematic_paths"
else
    echo "âœ… No se encontraron paths obvios problemÃ¡ticos"
fi

echo ""
echo "ðŸ”§ APLICANDO FIX ULTRA-AGRESIVO AL PROJECT.PBXPROJ..."

# Crear backup
cp "Runner.xcodeproj/project.pbxproj" "Runner.xcodeproj/project.pbxproj.ultra-backup"

# MÃšLTIPLES PATRONES DE CORRECCIÃ“N MÃS AGRESIVOS
echo "ðŸŽ¯ Corrigiendo mÃºltiples patrones de paths absolutos..."

# PatrÃ³n 1: Paths que empiezan con comillas + slash
sed -i '' 's|"/Target Support Files/|"${PODS_ROOT}/Target Support Files/|g' "Runner.xcodeproj/project.pbxproj"

# PatrÃ³n 2: Paths sin comillas al inicio  
sed -i '' 's|/Target Support Files/|${PODS_ROOT}/Target Support Files/|g' "Runner.xcodeproj/project.pbxproj"

# PatrÃ³n 3: Paths sin slash inicial
sed -i '' 's|Target Support Files/|${PODS_ROOT}/Target Support Files/|g' "Runner.xcodeproj/project.pbxproj"

# PatrÃ³n 4: Paths especÃ­ficos problemÃ¡ticos observados
sed -i '' 's|/Target Support Files/FirebaseAnalytics/|${PODS_ROOT}/Target Support Files/FirebaseAnalytics/|g' "Runner.xcodeproj/project.pbxproj"
sed -i '' 's|/Target Support Files/GoogleAppMeasurement/|${PODS_ROOT}/Target Support Files/GoogleAppMeasurement/|g' "Runner.xcodeproj/project.pbxproj"

# PatrÃ³n 5: Cualquier referencia que no tenga PODS_ROOT
sed -i '' 's|"Target Support Files/|"${PODS_ROOT}/Target Support Files/|g' "Runner.xcodeproj/project.pbxproj"

echo "âœ… MÃºltiples patrones de correcciÃ³n aplicados"

echo ""
echo "ðŸ” VERIFICACIÃ“N POST-CORRECCIÃ“N..."

# Verificar que los cambios se aplicaron
corrected_paths=$(grep -n "PODS_ROOT.*Target Support Files" "Runner.xcodeproj/project.pbxproj" | wc -l)
remaining_absolute=$(grep -n '".*Target Support Files' "Runner.xcodeproj/project.pbxproj" | grep -v "PODS_ROOT" | wc -l)

echo "âœ… Paths corregidos con PODS_ROOT: $corrected_paths"
echo "âš ï¸ Paths absolutos restantes: $remaining_absolute"

if [ "$remaining_absolute" -gt 0 ]; then
    echo "âŒ PATHS ABSOLUTOS AÃšN PRESENTES:"
    grep -n '".*Target Support Files' "Runner.xcodeproj/project.pbxproj" | grep -v "PODS_ROOT" | head -5
fi

echo ""
echo "ðŸ“ CREANDO ARCHIVOS .XCFILELIST EN UBICACIONES EXACTAS..."

# Targets Firebase crÃ­ticos
FIREBASE_TARGETS=("FirebaseAnalytics" "GoogleAppMeasurement" "FirebaseCore" "FirebaseAuth")

for target in "${FIREBASE_TARGETS[@]}"; do
    target_dir="Pods/Target Support Files/${target}"
    
    echo "ðŸ“ Procesando: $target"
    
    # Crear directorio si no existe
    if [ ! -d "$target_dir" ]; then
        echo "ðŸ“‚ Creando directorio: $target_dir"
        mkdir -p "$target_dir"
    fi
    
    # Archivos exactos que Xcode estÃ¡ buscando
    input_file="${target_dir}/${target}-xcframeworks-input-files.xcfilelist"
    output_file="${target_dir}/${target}-xcframeworks-output-files.xcfilelist"
    
    # CREAR INPUT FILE CON CONTENIDO ROBUSTO
    echo "ðŸ“ Creando: $input_file"
    cat > "$input_file" << EOF
# Firebase $target Input Files - Generated by MobilePro Ultra Fix
\${PODS_ROOT}/Target Support Files/$target/$target.xcframework
\${PODS_ROOT}/$target/Frameworks/$target.xcframework
\${BUILT_PRODUCTS_DIR}/$target/$target.framework
\${PODS_CONFIGURATION_BUILD_DIR}/$target/$target.framework
EOF

    # CREAR OUTPUT FILE CON CONTENIDO ROBUSTO
    echo "ðŸ“ Creando: $output_file"
    cat > "$output_file" << EOF
# Firebase $target Output Files - Generated by MobilePro Ultra Fix  
\${TARGET_BUILD_DIR}/\${FRAMEWORKS_FOLDER_PATH}/$target.framework
\${BUILT_PRODUCTS_DIR}/\${FRAMEWORKS_FOLDER_PATH}/$target.framework
\${CONFIGURATION_BUILD_DIR}/\${FRAMEWORKS_FOLDER_PATH}/$target.framework
EOF

    # Verificar archivos creados
    if [ -f "$input_file" ] && [ -f "$output_file" ]; then
        echo "âœ… $target: archivos creados correctamente"
        echo "   ðŸ“ Input:  $(realpath "$input_file")"
        echo "   ðŸ“ Output: $(realpath "$output_file")"
    else
        echo "âŒ $target: ERROR creando archivos"
    fi
done

echo ""
echo "ðŸ” VERIFICACIÃ“N FINAL EXHAUSTIVA..."

echo "ðŸ“Š Resumen archivos .xcfilelist:"
for target in "${FIREBASE_TARGETS[@]}"; do
    target_dir="Pods/Target Support Files/${target}"
    input_file="${target_dir}/${target}-xcframeworks-input-files.xcfilelist"
    output_file="${target_dir}/${target}-xcframeworks-output-files.xcfilelist"
    
    status_input="âŒ"
    status_output="âŒ"
    size_input="0"
    size_output="0"
    
    if [ -f "$input_file" ]; then
        status_input="âœ…"
        size_input=$(wc -c < "$input_file")
    fi
    
    if [ -f "$output_file" ]; then
        status_output="âœ…"
        size_output=$(wc -c < "$output_file")
    fi
    
    echo "$target: Input $status_input (${size_input}b) Output $status_output (${size_output}b)"
done

echo ""
echo "ðŸ“‹ VerificaciÃ³n project.pbxproj final:"
firebase_refs=$(grep -c "FirebaseAnalytics\|GoogleAppMeasurement" "Runner.xcodeproj/project.pbxproj")
pods_root_refs=$(grep -c "PODS_ROOT.*Target Support Files" "Runner.xcodeproj/project.pbxproj")
absolute_refs=$(grep -c '"/Target Support Files/' "Runner.xcodeproj/project.pbxproj" || echo "0")

echo "ðŸ”¥ Firebase referencias: $firebase_refs"
echo "âœ… PODS_ROOT referencias: $pods_root_refs"  
echo "âŒ Paths absolutos restantes: $absolute_refs"

echo ""
echo "âœ… FIX ULTRA-AGRESIVO COMPLETADO"
echo "ðŸŽ¯ project.pbxproj: MÃºltiples patrones de paths corregidos"
echo "ðŸ“ Archivos .xcfilelist: Creados en ubicaciones exactas"
echo "ðŸ”§ Contenido robusto: MÃºltiples rutas de fallback"
echo "ðŸš€ READY FOR BUILD - Paths absolutos eliminados"

if [ "$absolute_refs" -eq 0 ]; then
    echo "ðŸŽ‰ SUCCESS: No quedan paths absolutos problemÃ¡ticos"
else
    echo "âš ï¸ WARNING: AÃºn hay $absolute_refs paths absolutos"
fi
